name: Sistema de Marcaje AutomÃ¡tico - Enterprise

on:
  schedule:
    # HORARIO DE VERANO (septiembre - marzo): UTC-3
    - cron: "10 11 * * 1-5" # 08:10 CLT (Lunes a Viernes) - VERANO
    - cron: "30 20 * * 1-5" # 17:30 CLT (Lunes a Viernes) - VERANO
    
    # HORARIO DE INVIERNO (marzo - septiembre): UTC-4 (comentado)
    # - cron: "10 12 * * 1-5" # 08:10 CLT (Lunes a Viernes) - INVIERNO
    # - cron: "30 21 * * 1-5" # 17:30 CLT (Lunes a Viernes) - INVIERNO
    
    # Mantener repositorio activo - cada 15 dÃ­as a las 6:00 UTC (3:00 CLT)
    - cron: "0 6 1,15 * *" # DÃ­a 1 y 15 de cada mes
  
  # push:
  #   branches: ["main"]
  
  workflow_dispatch:
    inputs:
      debug_mode:
        description: "Forzar modo DEBUG"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  # Job para mantener el repositorio activo
  keep-alive:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 6 1,15 * *'
    permissions:
      contents: write  # Necesario para hacer push
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Actualizar timestamp de keep-alive
        run: |
          echo "# Keep Alive" > .github/keep-alive.txt
          echo "Last update: $(date -u)" >> .github/keep-alive.txt
          echo "Run number: ${{ github.run_number }}" >> .github/keep-alive.txt
          echo "Maintaining repository activity to prevent workflow deactivation" >> .github/keep-alive.txt

      - name: Commit y push cambios
        run: |
          git add .github/keep-alive.txt
          if git diff --staged --quiet; then
            echo "No hay cambios para commit"
          else
            git commit -m "chore: update keep-alive timestamp [skip ci]"
            git push
            echo "âœ… Keep-alive commit realizado exitosamente"
          fi

  marcar-turno:
    runs-on: ubuntu-latest
    if: github.event.schedule != '0 6 1,15 * *'
    timeout-minutes: 60  # 1 hora - Tiempo suficiente para procesos de marcaje
    env:
      CLOCK_IN_ACTIVE: ${{ secrets.CLOCK_IN_ACTIVE }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || secrets.DEBUG_MODE }}
      EMAIL_ADDRESS_B64: ${{ secrets.EMAIL_ADDRESS_B64 }}
      EMAIL_PASS_B64: ${{ secrets.EMAIL_PASS_B64 }}
      SPECIAL_EMAIL_TO: ${{ secrets.SPECIAL_EMAIL_TO }}
      DEFAULT_EMAIL_TO: ${{ secrets.DEFAULT_EMAIL_TO }}
      SPECIAL_RUT_B64: ${{ secrets.SPECIAL_RUT_B64 }}
      ACTIVE_RUTS_B64: ${{ secrets.ACTIVE_RUTS_B64 }}
      TZ: "America/Santiago"

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Instalar Chrome
        run: |
          # Instala la Ãºltima versiÃ³n de Chrome Stable
          # webdriver-manager (en requirements.txt) descarga automÃ¡ticamente el ChromeDriver compatible
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ No se encontrÃ³ requirements.txt"
            exit 1
          fi

      - name: Crear directorios necesarios
        run: |
          mkdir -p logs reports backups

      - name: Verificar configuraciÃ³n bÃ¡sica
        run: |
          echo "ðŸ”§ Verificando configuraciÃ³n bÃ¡sica..."
          python -c "
          from dotenv import load_dotenv
          import os
          load_dotenv()
          print('âœ… ConfiguraciÃ³n verificada')
          print(f'DEBUG_MODE: {os.getenv(\"DEBUG_MODE\", \"false\")}')
          print(f'CLOCK_IN_ACTIVE: {os.getenv(\"CLOCK_IN_ACTIVE\", \"true\")}')
          " || echo "âš ï¸ VerificaciÃ³n fallÃ³, continuando..."

      - name: Ejecutar sistema de marcaje
        run: |
          echo "ðŸš€ Iniciando sistema de marcaje..."
          echo "â° Hora de inicio: $(date)"
          echo "ðŸ”§ DEBUG_MODE: $DEBUG_MODE"
          python main.py || {
            echo "âŒ Error en ejecuciÃ³n principal"
            exit 1
          }
          echo "âœ… Sistema finalizado exitosamente"
          echo "â° Hora de fin: $(date)"
        env:
          PYTHONUNBUFFERED: 1
          GITHUB_RUN_NUMBER: ${{ github.run_number }}

      - name: Generar reporte post-ejecuciÃ³n
        if: always()
        run: |
          echo "ðŸ“Š Generando reporte post-ejecuciÃ³n..."
          python -c "
          try:
              import os
              from datetime import datetime
              print('ðŸ“Š Reporte simple:')
              print(f'   Timestamp: {datetime.now()}')
              print(f'   Run number: {os.environ.get(\"GITHUB_RUN_NUMBER\", \"N/A\")}')
              print(f'   Debug mode: {os.environ.get(\"DEBUG_MODE\", \"false\")}')
              if os.path.exists('logs'):
                  logs = [f for f in os.listdir('logs') if f.endswith('.log')]
                  print(f'   Logs generados: {len(logs)}')
              print('âœ… Reporte generado')
          except Exception as e:
              print(f'âš ï¸ Error en reporte: {e}')
          "

      - name: Mostrar estadÃ­sticas
        if: always()
        run: |
          echo "ðŸ“ Contenido del directorio logs:"
          ls -la logs/ || echo "No hay logs"
          echo ""
          echo "ðŸ“Š Archivos de reporte:"
          ls -la *.json 2>/dev/null || echo "No hay reportes JSON"

      - name: Subir archivo de logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: marcaje-logs-${{ github.run_number }}
          path: |
            logs/
          retention-days: 30